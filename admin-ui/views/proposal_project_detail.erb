<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposal Project: <%= @project[:name] %> - Wiseguy</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="/theme.js" defer></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">ü¶â</span>
                                            <span class="logo-text">Wiseguy</span>
                </div>
                <nav class="nav">
                    <a href="/" class="nav-link">Dashboard</a>
                    <a href="/sales-tools" class="nav-link active">Sales Tools</a>
                    <a href="/audits" class="nav-link">Audits</a>
                </nav>
            </div>
        </header>

        <main class="main-content">
            <div class="page-header">
                <div class="breadcrumb">
                    <a href="/sales-tools" class="breadcrumb-link">Sales Tools</a>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-current">Proposal: <%= @project[:name] %></span>
                </div>
                <h1 class="page-title">Proposal Project: <%= @project[:name] %></h1>
            </div>

            <div class="stats-section">
                <div class="stat-card">
                    <div class="stat-icon">üìã</div>
                    <div class="stat-content">
                        <div class="stat-value"><%= @project[:input_count] %></div>
                        <div class="stat-label">Input Files</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÑ</div>
                    <div class="stat-content">
                        <div class="stat-value"><%= @project[:output_count] %></div>
                        <div class="stat-label">Output Files</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-content">
                        <div class="stat-value">$<%= number_with_delimiter(@project[:estimated_value] || 0) %></div>
                        <div class="stat-label">Est. Value</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-content">
                        <div class="stat-value"><%= @project[:last_modified] %></div>
                        <div class="stat-label">Last Modified</div>
                    </div>
                </div>
            </div>

            <!-- CRM Integration -->
            <%= erb :crm_integration %>

            <div class="nav-tabs">
                <button class="tab-button active" onclick="showTab('files')">Files</button>
                <button class="tab-button" onclick="showTab('scripts')">Scripts</button>
                <button class="tab-button" onclick="showTab('output')">Output</button>
            </div>

            <div id="files" class="tab-content active">
                <div class="card">
                    <h3>Input Files</h3>
                    <% if @project[:input_files].any? %>
                        <div class="file-list">
                            <% @project[:input_files].each do |file| %>
                                <div class="file-item">
                                    <span class="file-icon">üìÅ</span>
                                    <span class="file-name"><%= file %></span>
                                </div>
                            <% end %>
                        </div>
                    <% else %>
                        <p class="empty-state">No input files found.</p>
                    <% end %>
                </div>

                <div class="card">
                    <h3>Text Files</h3>
                    <% if @project[:text_files].any? %>
                        <div class="file-list">
                            <% @project[:text_files].each do |file| %>
                                <div class="file-item">
                                    <span class="file-icon">üìÑ</span>
                                    <span class="file-name"><%= file %></span>
                                </div>
                            <% end %>
                        </div>
                    <% else %>
                        <p class="empty-state">No text files found.</p>
                    <% end %>
                </div>
            </div>

            <div id="scripts" class="tab-content">
                <div class="card">
                    <h3>Python Scripts</h3>
                    <% if @project[:python_files].any? %>
                        <div class="script-list">
                            <% @project[:python_files].each do |script| %>
                                <div class="script-item">
                                    <div class="script-info">
                                        <span class="script-icon">üêç</span>
                                        <span class="script-name"><%= script %></span>
                                    </div>
                                    <button class="btn" onclick="runScript('<%= script %>')">Run Script</button>
                                </div>
                            <% end %>
                        </div>
                    <% else %>
                        <p class="empty-state">No Python scripts found.</p>
                    <% end %>
                </div>
            </div>

            <div id="output" class="tab-content">
                <div class="card">
                    <h3>Output Files</h3>
                    <% if @project[:output_files].any? %>
                        <div class="file-list">
                            <% @project[:output_files].each do |file| %>
                                <div class="file-item">
                                    <span class="file-icon">üìÑ</span>
                                    <span class="file-name"><%= file %></span>
                                </div>
                            <% end %>
                        </div>
                    <% else %>
                        <p class="empty-state">No output files found.</p>
                    <% end %>
                </div>
            </div>

            <div class="action-buttons">
                <a href="/sales-tools" class="btn secondary">Back to Sales Tools</a>
                <button class="btn" onclick="deleteProject()">Delete Project</button>
            </div>
        </main>
    </div>

    <script>
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        function runScript(scriptName) {
            if (!confirm(`Are you sure you want to run ${scriptName}?`)) {
                return;
            }

            fetch('/api/sales-tools/proposal/run-script', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    project_name: '<%= @project[:name] %>',
                    script_name: scriptName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Script ${scriptName} executed successfully!\n\nOutput:\n${data.stdout}`);
                } else {
                    alert(`Script execution failed:\n${data.error || data.stderr}`);
                }
            })
            .catch(error => {
                alert(`Error running script: ${error.message}`);
            });
        }

        function deleteProject() {
            if (!confirm('Are you sure you want to delete this proposal project? This action cannot be undone.')) {
                return;
            }

            fetch('/api/sales-tools/proposal/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: '<%= @project[:name] %>'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Project deleted successfully!');
                    window.location.href = '/sales-tools';
                } else {
                    alert(`Error deleting project: ${data.error}`);
                }
            })
            .catch(error => {
                alert(`Error deleting project: ${error.message}`);
            });
        }
    </script>
</body>
</html>
