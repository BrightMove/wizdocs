<!DOCTYPE html>
<html lang="en" data-theme="system">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOW Project: <%= @project[:name] %> - Wiseguy</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="/theme.js" defer></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">ü¶â</div>
                    <div class="logo-text">
                        <h1>Wiseguy</h1>
                        <p>Agentic AI Platform</p>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="theme-toggle" data-theme="system" onclick="ThemeManager.toggle()">
                        <span class="theme-icon">üåô</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <a href="/" class="nav-tab">Dashboard</a>
            <a href="/sales-tools" class="nav-tab active">Sales Tools</a>
            <a href="/audits" class="nav-tab">Audits</a>
            <a href="/settings" class="nav-tab">Settings</a>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <div style="margin-bottom: 24px;">
                    <a href="/sales-tools" class="btn secondary" style="display: inline-flex; align-items: center; gap: 8px; width: auto;">
                        <span>‚Üê</span>
                        <span>Back to Sales Tools</span>
                    </a>
                </div>

                <!-- Project Header -->
                <div class="card fade-in-up">
                    <div class="card-header">
                        <div class="card-icon success">üìÑ</div>
                        <div style="flex: 1;">
                            <h2 class="card-title"><%= @project[:name] %></h2>
                            <p style="margin: 4px 0 0 0; color: var(--text-secondary); font-size: 14px;">
                                SOW Project ‚Ä¢ Last modified: <%= @project[:last_modified] %>
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: 600; color: var(--accent-success);">
                                <% estimated_value = @sales_tools.get_project_estimated_value(@project[:name], 'sow') %>
                                $<%= number_with_delimiter(estimated_value) %>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Estimated Value</div>
                        </div>
                    </div>
                    <p class="card-description">
                        AI-powered Statement of Work generation with automated scope definition, deliverable tracking, and comprehensive project planning.
                    </p>
                </div>

                <!-- Project Stats -->
                <div class="stats-section fade-in-up" style="animation-delay: 0.1s;">
                    <div class="stats-header">
                        <div class="stats-icon primary">üìä</div>
                        <h3 class="stats-title">Project Overview</h3>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number"><%= @project[:input_count] %></div>
                            <div class="stat-label">Input Files</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number"><%= @project[:output_count] %></div>
                            <div class="stat-label">Output Files</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number"><%= @project[:python_files].length %></div>
                            <div class="stat-label">Python Scripts</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number"><%= @project[:text_files].length %></div>
                            <div class="stat-label">Text Files</div>
                        </div>
                    </div>
                </div>

                <!-- CRM Integration -->
                <%= erb :crm_integration %>

                <!-- Input Files -->
                <div class="card fade-in-up" style="animation-delay: 0.2s;">
                    <div class="card-header">
                        <div class="card-icon primary">üìÅ</div>
                        <h3 class="card-title">Input Files</h3>
                    </div>
                    <% if @project[:input_files].any? %>
                        <div style="display: grid; gap: 12px;">
                            <% @project[:input_files].each do |file| %>
                                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-secondary);">
                                    <span style="font-size: 16px;">üìÑ</span>
                                    <span style="font-weight: 500; color: var(--text-primary);"><%= file %></span>
                                </div>
                            <% end %>
                        </div>
                    <% else %>
                        <p style="color: var(--text-secondary); text-align: center; padding: 20px;">No input files found. Upload project requirements to the input directory.</p>
                    <% end %>
                </div>

                <!-- Output Files -->
                <div class="card fade-in-up" style="animation-delay: 0.3s;">
                    <div class="card-header">
                        <div class="card-icon success">üìÑ</div>
                        <h3 class="card-title">Output Files</h3>
                    </div>
                    <% if @project[:output_files].any? %>
                        <div style="display: grid; gap: 12px;">
                            <% @project[:output_files].each do |file| %>
                                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-secondary);">
                                    <span style="font-size: 16px;">üìã</span>
                                    <span style="font-weight: 500; color: var(--text-primary);"><%= file %></span>
                                </div>
                            <% end %>
                        </div>
                    <% else %>
                        <p style="color: var(--text-secondary); text-align: center; padding: 20px;">No output files found. Run analysis scripts to generate SOW documents.</p>
                    <% end %>
                </div>

                <!-- Python Scripts -->
                <div class="card fade-in-up" style="animation-delay: 0.4s;">
                    <div class="card-header">
                        <div class="card-icon warning">üêç</div>
                        <h3 class="card-title">Python Scripts</h3>
                    </div>
                    <% if @project[:python_files].any? %>
                        <div style="display: grid; gap: 16px;">
                            <% @project[:python_files].each do |script| %>
                                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; border: 1px solid var(--border-secondary);">
                                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 12px;">
                                        <h4 style="margin: 0; color: var(--text-primary); font-size: 16px; font-weight: 600;"><%= script %></h4>
                                        <button onclick="runScript('<%= script %>')" class="btn success" style="width: auto; padding: 8px 16px; font-size: 14px;">Run Script</button>
                                    </div>
                                    <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">AI-powered SOW generation script</p>
                                    <div id="log-<%= script.gsub(/[^a-zA-Z0-9]/, '-') %>" class="execution-log" style="display: none; margin-top: 12px; background: var(--bg-tertiary); color: var(--text-primary); padding: 12px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; white-space: pre-wrap; max-height: 200px; overflow-y: auto; border: 1px solid var(--border-primary);"></div>
                                </div>
                            <% end %>
                        </div>
                    <% else %>
                        <p style="color: var(--text-secondary); text-align: center; padding: 20px;">No Python scripts found in this project.</p>
                    <% end %>
                </div>

                <!-- Text Files -->
                <div class="card fade-in-up" style="animation-delay: 0.5s;">
                    <div class="card-header">
                        <div class="card-icon primary">üìù</div>
                        <h3 class="card-title">Text Files</h3>
                    </div>
                    <% if @project[:text_files].any? %>
                        <div style="display: grid; gap: 12px;">
                            <% @project[:text_files].each do |file| %>
                                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-secondary);">
                                    <span style="font-size: 16px;">üìÑ</span>
                                    <span style="font-weight: 500; color: var(--text-primary);"><%= file %></span>
                                </div>
                            <% end %>
                        </div>
                    <% else %>
                        <p style="color: var(--text-secondary); text-align: center; padding: 20px;">No text files found.</p>
                    <% end %>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        function runScript(scriptName) {
            const logElement = document.getElementById(`log-${scriptName.replace(/[^a-zA-Z0-9]/g, '-')}`);
            logElement.style.display = 'block';
            logElement.textContent = 'Running script... Please wait...';
            
            fetch('/api/sales-tools/sow/run-script', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    project_name: '<%= @project[:name] %>', 
                    script_name: scriptName 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    logElement.textContent = `Script executed successfully!\n\nSTDOUT:\n${data.stdout}\n\nSTDERR:\n${data.stderr}\n\nExit Code: ${data.exit_code}`;
                } else {
                    logElement.textContent = `Error: ${data.error}\n\nSTDOUT:\n${data.stdout || ''}\n\nSTDERR:\n${data.stderr || ''}\n\nExit Code: ${data.exit_code || 'N/A'}`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                logElement.textContent = `Error running script: ${error.message}`;
            });
        }
    </script>
</body>
</html>
